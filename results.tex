\chapter{Results}
\label{chap:results}

\section{Cs-En dataset}

% Detailed info of cs-en-wmt13 experiments
\begin{table}[ht]
\centering
\begin{tabular}{ r p{10cm} }
Name & Description and parameters to \verb|train-model.perl| \\
\hline
\hline
baseline & Standard Moses pipeline with no special parameters \\
opt-baseline & Standard Moses pipeline with an optimized setup that is
available in Moses 1.0:
\verb|--sort-compress gzip|, \verb|--sort-buffer 20G| and \verb|--cores 15| \\
eppex-zero & \eppex{} set to no pruning and \verb|--GZOutput| option \\
eppex-zero-n & \eppex{} with \verb|--limits| set to \verb|1:0:1,2:0:2,...,7:0:7|
and \verb|--GZOutput| option \\
\hline
\hline
\end{tabular}
\caption{\label{cs-en-wmt13-scenarios}List of various experiments and their
settings for "Cs-En" setup.}
\end{table}

\subsection{Memory and time requirements}

\begin{table}[ht]
\centering
\begin{tabular}{ | c | c c | c c | c c | }
\hline
name & \multicolumn{2}{|c|}{total} & \multicolumn{2}{|c|}{phrase extraction} & \multicolumn{2}{|c|}{phrase scoring} \\
 & wall & CPU & wall & CPU & wall & CPU \\
\hline
\hline
baseline     & 16:53:15 & 15:26:13 & 07:10:46 & 05:36:04 & 09:42:29 & 09:50:09 \\
opt-baseline & ??:??:?? & ??:??:?? & ??:??:?? & ??:??:?? & ??:??:?? & ??:??:?? \\ % TODO!
eppex-zero   & ??:??:?? & ??:??:?? & -- & -- & -- & -- \\ % TODO!
\hline
eppex-zero-n & 01:33:50 & 01:33:44 & -- & -- & -- & -- \\
\hline
\end{tabular}
\caption{\label{cs-en-wmt13-time-benchmarks}Wallclock times and CPU usage values
(in hh:mm:ss format) of the phrase table construction for various experiments
of "Cs-En" setup.}
\end{table}

\begin{table}[ht]
\centering
\begin{tabular}{ | c | c | }
\hline
name & VM peak \\
\hline
\hline
baseline      & 2.1~GB \\
opt-baseline  & ?.?~GB \\ % TODO.
eppex-zero    & ?.?~GB \\ % TODO.
\hline
eppex-zero-n  & 10.5~GB \\
\hline
\end{tabular}
\caption{\label{cs-en-wmt13-vm-peak-benchmarks}Virtual memory peaks of
the phrase table construction for various experiments of "Cs-En" setup.}
\end{table}

\subsection{Eppex memory usage}

% TODO: Attach a graph displaying the rate of growth of memory usage with 1M steps


\section{The big Fr-En dataset}

% Detailed info of fr-en-80 experiments
\begin{table}[ht]
\centering
\begin{tabular}{ r p{10cm} }
Name & Description and parameters to \verb|train-model.perl| \\
\hline
\hline
baseline & Standard Moses pipeline with no special parameters \\
opt-baseline & Standard Moses pipeline with an optimized setup that is
available in Moses 1.0:
\verb|--sort-compress gzip|, \verb|--sort-buffer 20G| and \verb|--cores 15| \\
eppex-zero       & \eppex{} set to no pruning and \verb|--GZOutput| option \\
eppex-zero-n     & \eppex{} with \verb|--limits| set to \verb|1:0:1,2:0:2,...,7:0:7|
and \verb|--GZOutput| option \\
eppex-defensive  & \eppex{} with \verb|--limits| set to ... % TODO.
and \verb|--GZOutput| option \\
\hline
\hline
\end{tabular}
\caption{\label{fr-en-80-scenarios}List of various experiments and their
settings for "Fr-En" setup.}
\end{table}


\section{Comparison to 2011 version}
% Comparison of current eppex and phrase-extract performance vs. mid-2011 state

\citet{przywara:eppex} presented an evaluation of an early version of \eppex{}
that was able to only extract phrases. It performed a faster phrase
table creation than the legacy \emph{phrase-extract} in such situations,
where lossy counting resulted in significant filtration of extracted phrase
pairs and consequent sub-steps (sorting, scoring and consolidation of both
phrase table halves) had to process reduced amount of data;
eventually the whole process of phrase table creation finished faster.

As we had all the parallel data used in their experiments available and
we perform our runtime benchmarking in almost identical manner,
we decided to carry out comparison between early and current version of
both \eppex{} as well as \emph{phrase-extract} toolkit.

\subsection{Implementation differences}

The current version of \eppex{} differs from the early version mainly in the
capability of performing not only phrase pairs extraction, but a complete
phrase table construction (that is including phrase pairs scoring).
The early version, however, could be used to extract orientation info
the same way \emph{extract} can, while this functionality has been dropped
from the current version as not related to the core task of phrase table creation.
Following the upgrade of \emph{phrase-extract} suite, an option to read from
gzipped input files and dump gzipped output files has been added to \eppex{}.
Internally, there have been a multitude of performance tweaks,
as performance optimization is the most important aim in \eppex{} development,
but a full listing of implementation changes would be purposeless here.

On the contrary, \emph{phrase-extract} suite has been updated mainly in order to
provide a richer functionality, but three changes since the mid-2011 version
had sound impact on its runtime performance: the optimization of target phrases
scanning in \emph{scorer} implementation,\footnote{Commit 677378774aca30c8f0d4ca57267f7ac5ef7d7cb6.}
adding an option to gzip the output directly within the main three binaries
(\emph{extract}, \emph{scorer} and \emph{consolidate})
and parallelization of both phrase extraction and phrase scoring
steps.\footnote{See \texttt{extract-parallel.perl} and \texttt{score-parallel.perl}
in \texttt{<moses>/scripts/generic/}.}

\subsection{Parameters of experiments}

\Tref{cu-bojar-scenarios} presents all the experiments and their settings.
The \emph{baseline} experiment has no special parameters set for phrase table
construction except for \verb|--GZOutput| -- an option that turns on output
gzipping that is now implicitly set on from within the training script.
Because of this, we also set this option on for \eppex{} runs.
We experimented with different pruning parameters: \emph{eppex-1-in} (milder
pruning) and \emph{eppex-1-out} (harsher pruning) are using the same pruning
parameters as 2011 experiments and we also perform \emph{eppex-zero} experiment
(an \eppex{} run with no pruning).
Finally, the \emph{opt-baseline} experiment is an attempt to establish more
challenging baseline with respect to the computation resources of our machine:
multiple CPU threads are used for training and a massive amount of memory is
dedicated to the sorting processes.

% Detailed info of cu-bojar experiments
\begin{table}[ht]
\centering
\begin{tabular}{ r p{10cm} }
Name & Description and parameters to \verb|train-model.perl| \\
\hline
\hline
baseline & Standard Moses pipeline with no special parameters \\
opt-baseline & Standard Moses pipeline with an optimized setup that is
available in Moses 1.0:
\verb|--sort-compress gzip|, \verb|--sort-buffer 12G| and \verb|--cores 7| \\
eppex-zero & \eppex{} set to no pruning and \verb|--GZOutput| option \\
eppex-1-in & \eppex{} with pruning thresholds set to keep in
all phrase pairs of length 1--3 and prune longer phrase pairs
with max. positive threshold of 8 and \verb|--GZOutput| option \\
eppex-1-out & \eppex{} with pruning thresholds set to remove
all single-occurring phrase pairs and prune the rest with
max. positive threshold of 8 and \verb|--GZOutput| option \\
\hline
\hline
\end{tabular}
\caption{\label{cu-bojar-scenarios}List of various experiments and their
settings for "cu-bojar" setup. The parameters of "baseline", "eppex-1-in"
and "eppex-1-out" are set in such a way that they conform to the
corresponding 2011 experiments.}
\end{table}

\subsection{Memory and time requirements}

% NOTE:
% Steps and substeps of phrase table construction via train-model.perl back in 2011:
% (1) Phrase extraction
%  a) extract
%  b) gzip f2e
%  c) gzip e2f
% (2) Phrase scoring
%  d) sort f2e (now done in (1) and so reported as part of phrase extraction in table below)
%  e) score e2f
%  f) sort e2f (now done in (1) and so reported as part of phrase extraction in table below)
%  g) score e2f
%  h) sort inv
%  i) cons
%  j) gzip pt

\Tref{cu-bojar-time-benchmarks} compares wallclock times and CPU usage of all the
experiments and in case of baseline and 2011 experiments also separately for phrase
extraction and phrase scoring steps.

The comparison between old and current baseline reveals that the optimization of
\emph{scorer} mentioned above resulted in a speed up by more than a factor of two.
On the other hand the non-optimized phrase extraction became slightly more time demanding,
but this may be explained by the fact that parallelization incurred some overhead
that does not pay back when running only with a single core, but significantly cuts
down the running time when using multiple cores: in our setup using 7~cores (along with
more memory for sorting) lowered time of phrase extraction to 40\% and of phrase scoring
to almost 50\%.

The comparison between 2011 and current version of \eppex{} also display a significant
speed up: with harsh pruning the phrase table construction is done in 30~minutes (took
almost two hours in 2011) and without any pruning the full phrase table was built in
less than 90~minutes, thus \eppex{} proves to be a viable alternative to
\emph{phrase-extract} also in situations, when pruning is not an option (being twice as
fast than our optimized baseline).

\begin{table}[ht]
\centering
\begin{tabular}{ | c | c c | c c | c c | }
\hline
name & \multicolumn{2}{|c|}{total} & \multicolumn{2}{|c|}{phrase extraction} & \multicolumn{2}{|c|}{phrase scoring} \\
 & wall & CPU & wall & CPU & wall & CPU \\
\hline
\hline
baseline*    & 08:49:44 & 07:03:48 & 02:05:56 & 01:00:09 & 06:43:48 & 06:03:39 \\
baseline     & 05:44:12 & 04:47:41 & 02:36:00 & 01:33:40 & 03:08:12 & 03:14:00 \\
opt-baseline & 02:42:15 & 05:57:45 & 01:00:03 & 01:39:16 & 01:42:12 & 04:18:29 \\
eppex-zero   & 01:22:53 & 01:22:49 & -- & -- & -- & -- \\
\hline
eppex-1-in*  & 04:03:04 & 03:42:29 & 01:48:14 & 01:28:53 & 02:14:50 & 02:13:36 \\
eppex-1-in   & 00:44:10 & 00:44:08 & -- & -- & -- & -- \\
\hline
eppex-1-out* & 01:50:03 & 01:36:19 & 01:35:38 & 01:21:57 & 00:14:25 & 00:14:22 \\
eppex-1-out  & 00:30:23 & 00:30:21 & -- & -- & -- & -- \\
\hline
\end{tabular}
\caption{\label{cu-bojar-time-benchmarks}Wallclock times and CPU usage values
(in hh:mm:ss format) of the phrase table construction for various experiments
of "cu-bojar" setup. Asterisk denotes the particular measures from 2011
experiments.}
\end{table}

\Tref{cu-bojar-vm-peak-benchmarks} presents memory peaks of all the
experiments.
Memory demands of the baseline keeps to be low, the 0.1~GB difference between 2011
and now stems from the fact that our benchmarking script includes the main process
into the set of measured processes.
An optimized baseline is the most memory demanding, but this is only because we
assigned 12~GB of RAM to the sorting processes and both phrase table halves are sorted
simultaneously after phrase extraction.

Memory demands of current version of \eppex{} are significantly lower than of the 2011
version: in 2011, the harsh pruning setup required as much memory as the current version
run without any pruning at all.

\begin{table}[ht]
\centering
\begin{tabular}{ | c | c | }
\hline
name & VM peak \\
\hline
\hline
baseline*    & 1.1~GB \\
baseline     & 1.2~GB \\
opt-baseline & 24.1~GB \\
eppex-zero   & 16.8~GB \\
\hline
eppex-1-in*  & 19.2~GB \\
eppex-1-in   & 13.4~GB \\
\hline
eppex-1-out* & 16.7~GB \\
eppex-1-out  & 11.3~GB \\
\hline
\end{tabular}
\caption{\label{cu-bojar-vm-peak-benchmarks}Virtual memory peaks of
the phrase table construction for various experiments of "cu-bojar" setup.
Asterisk denotes the particular measures from 2011 experiments.}
\end{table}
